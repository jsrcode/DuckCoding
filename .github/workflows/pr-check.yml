name: PR Check

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  check:
    name: Check (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-22.04
            os: ubuntu-22.04
          - name: windows-latest
            os: windows-latest
          - name: macos-arm64
            os: macos-14
          - name: macos-x64
            os: macos-13

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libjavascriptcoregtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Ensure WebView2 runtime (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $exists = Get-ChildItem 'HKLM:\SOFTWARE\Microsoft\EdgeUpdate\Clients' -ErrorAction SilentlyContinue |
            Where-Object { (Get-ItemProperty $_.PSPath).name -match 'WebView2 Runtime' }
          if ($exists) {
            Write-Host 'WebView2 Runtime already installed.'
            return
          }
          Write-Host 'WebView2 Runtime not found, try winget...'
          try {
            winget install --id Microsoft.EdgeWebView2Runtime --exact --accept-package-agreements --accept-source-agreements --silent
            return
          } catch {
            Write-Host 'winget failed, fallback to offline installer...'
          }
          $tmp = Join-Path $env:TEMP 'MicrosoftEdgeWebview2Setup.exe'
          Invoke-WebRequest 'https://go.microsoft.com/fwlink/p/?LinkId=2124703' -OutFile $tmp
          & $tmp /silent /install
          $exists = Get-ChildItem 'HKLM:\SOFTWARE\Microsoft\EdgeUpdate\Clients' -ErrorAction SilentlyContinue |
            Where-Object { (Get-ItemProperty $_.PSPath).name -match 'WebView2 Runtime' }
          if (-not $exists) { throw 'WebView2 Runtime install failed' }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.0
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy,rustfmt

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri -> target'
          cache-on-failure: true

      - name: Install JS dependencies
        run: npm ci

      - name: npm run check
        id: check
        shell: bash
        run: |
          npm run check 2>&1 | tee check.log
        continue-on-error: true

      - name: npm run check:fix (diagnostic)
        id: check_fix
        if: steps.check.outcome == 'failure'
        shell: bash
        run: |
          npm run check:fix 2>&1 | tee check-fix.log
        continue-on-error: true

      - name: npm run check (post-fix)
        id: recheck
        if: steps.check.outcome == 'failure'
        shell: bash
        run: |
          npm run check 2>&1 | tee check-recheck.log
        continue-on-error: true

      - name: Collect logs
        if: always()
        shell: bash
        run: |
          [ -f check.log ] || echo 'log not generated' > check.log
          [ -f check-fix.log ] || echo 'log not generated' > check-fix.log
          [ -f check-recheck.log ] || echo 'log not generated' > check-recheck.log

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-check-${{ matrix.name }}
          path: |
            check.log
            check-fix.log
            check-recheck.log

      - name: Update PR comment
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          MATRIX_NAME: ${{ matrix.name }}
          RUN_ID: ${{ github.run_id }}
          JOB_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          CHECK_OUTCOME: ${{ steps.check.outcome }}
          FIX_OUTCOME: ${{ steps.check_fix.outcome }}
          RECHECK_OUTCOME: ${{ steps.recheck.outcome }}
          ARTIFACT_NAME: pr-check-${{ matrix.name }}
        with:
          script: |
            const marker = '<!-- duckcoding-pr-check -->';
            const stateMarker = '<!-- duckcoding-pr-check-state:';
            const platforms = ['ubuntu-22.04', 'windows-latest', 'macos-arm64', 'macos-x64'];

            const defaultState = () =>
              Object.fromEntries(
                platforms.map((p) => [
                  p,
                  {
                    platform: p,
                    status: 'pending',
                    check: 'pending',
                    fix: 'pending',
                    recheck: 'pending',
                    artifact: '',
                    run_url: ''
                  }
                ])
              );

            const newEntry = {
              platform: process.env.MATRIX_NAME,
              check: process.env.CHECK_OUTCOME || 'skipped',
              fix: process.env.FIX_OUTCOME || 'skipped',
              recheck: process.env.RECHECK_OUTCOME || 'skipped',
              artifact: process.env.ARTIFACT_NAME,
              run_url: process.env.JOB_URL
            };

            if (newEntry.check === 'success') newEntry.status = 'success';
            else if (newEntry.check === 'failure' && newEntry.recheck === 'success') newEntry.status = 'fix_pass';
            else if (newEntry.check === 'failure') newEntry.status = 'failed';
            else newEntry.status = 'pending';

            const statusLabelZh = (entry) => {
              if (entry.status === 'pending') return 'â³ è¿è¡Œä¸­...';
              if (entry.status === 'success') return 'âœ… ç›´æŽ¥é€šè¿‡';
              if (entry.status === 'fix_pass') return 'ðŸŸ¡ è‡ªåŠ¨ä¿®å¤åŽé€šè¿‡ï¼ˆè¯·æœ¬åœ°æäº¤ä¿®å¤ï¼‰';
              return 'âŒ ä»æœªé€šè¿‡';
            };

            const statusLabelEn = (entry) => {
              if (entry.status === 'pending') return 'â³ In progress...';
              if (entry.status === 'success') return 'âœ… Passed';
              if (entry.status === 'fix_pass') return 'ðŸŸ¡ Passed after auto-fix (commit locally)';
              return 'âŒ Still failing';
            };

            const detail = (entry) =>
              entry.status === 'pending'
                ? '-'
                : `check=${entry.check} / fix=${entry.fix} / recheck=${entry.recheck}`;

            const linkOrDash = (entry) => (entry.run_url ? `[æ—¥å¿—](${entry.run_url})` : '-');
            const artifactOrDash = (entry) => (entry.status === 'pending' ? '-' : entry.artifact || '-');

            const renderTable = (labelFn, header) => {
              const h = header || {
                platform: 'å¹³å°/Platform',
                status: 'ç»“æžœ/Status',
                detail: 'æ˜Žç»†/Detail',
                artifact: 'æ—¥å¿—åŒ…',
                link: 'è¿è¡Œé“¾æŽ¥'
              };
              const rows = platforms
                .map((p) => {
                  const e = state[p] || defaultState()[p];
                  return `| ${pLabel(p)} | ${labelFn(e)} | ${detail(e)} | ${artifactOrDash(e)} | ${linkOrDash(e)} |`;
                })
                .join('\n');
              return [
                `| ${h.platform} | ${h.status} | ${h.detail} | ${h.artifact} | ${h.link} |`,
                '| --- | --- | --- | --- | --- |',
                rows
              ].join('\n');
            };

            const pLabel = (p) => {
              if (p === 'ubuntu-22.04') return 'ubuntu-22.04';
              if (p === 'windows-latest') return 'windows-latest';
              if (p === 'macos-arm64') return 'macos-14 (arm64)';
              if (p === 'macos-x64') return 'macos-13 (x64)';
              return p;
            };

            // Fetch existing comment with marker
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const existing = comments.find((c) => c.body.includes(marker));

            let state = defaultState();
            if (existing) {
              const match = existing.body.match(/<!-- duckcoding-pr-check-state:(.*?)-->/s);
              if (match) {
                try {
                  state = { ...state, ...JSON.parse(match[1]) };
                } catch {}
              }
            }
            state[newEntry.platform] = newEntry;

            const tableZh = renderTable(statusLabelZh, {
              platform: 'å¹³å°',
              status: 'ç»“æžœ',
              detail: 'æ˜Žç»†',
              artifact: 'æ—¥å¿—åŒ…',
              link: 'è¿è¡Œé“¾æŽ¥'
            });
            const tableEn = renderTable(statusLabelEn, {
              platform: 'Platform',
              status: 'Status',
              detail: 'Detail',
              artifact: 'Artifact',
              link: 'Run'
            });

            const body = [
              'æœ¬è¯„è®ºä¼šéšå„å¹³å°ä»»åŠ¡å®Œæˆè‡ªåŠ¨æ›´æ–°ï¼š',
              'å¦‚é¦–è½® `npm run check` å¤±è´¥ï¼Œè¯·åœ¨æœ¬åœ°æ‰§è¡Œ `npm run check:fix` â†’ `npm run check` å¹¶æäº¤ä¿®å¤ commitã€‚',
              'å¦‚ fix ä»å¤±è´¥ï¼Œè¯·åœ¨æœ¬åœ°æŽ’æŸ¥å¹¶ç¡®ä¿ `npm run check` é€šè¿‡åŽå†æäº¤ã€‚',
              'è·¨å¹³å°å·®å¼‚è‹¥æ— æ³•å¤çŽ°ï¼Œè¯·å¤åˆ¶æ—¥å¿—äº¤ç»™ AI èŽ·å–æŽ’æŸ¥å»ºè®®ã€‚',
              '',
              tableZh,
              '',
              '---',
              '',
              'This comment auto-updates as each platform finishes:',
              'If the first `npm run check` fails, run locally: `npm run check:fix` â†’ `npm run check` and commit the fix.',
              'If fix still fails, investigate locally and ensure `npm run check` passes before committing.',
              'If cross-platform issues canâ€™t be reproduced, copy logs to an AI for hints.',
              '',
              tableEn,
              marker,
              `${stateMarker}${JSON.stringify(state)} -->`
            ].join('\n');

            if (existing) {
              await github.rest.issues.updateComment({
                comment_id: existing.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }

      - name: Fail if initial check failed
        if: steps.check.outcome == 'failure'
        run: exit 1
